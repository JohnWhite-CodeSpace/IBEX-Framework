<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IBEX_Module.TensorAnalyzer &#8212; IBEX Framework 1.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=61243dd2"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for IBEX_Module.TensorAnalyzer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mutual_info_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">spearmanr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Jan Biały&quot;</span>

<div class="viewcode-block" id="ChannelAnalyzer">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ChannelAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ChannelAnalyzer</span>
<span class="sd">    ===============</span>

<span class="sd">    Class responsible for preprocessing IBEX ENA data based on high-quality acquisition</span>
<span class="sd">    time intervals specified in instruction files (HiCullGoodTimes.txt and LoGoodTimes.txt).</span>

<span class="sd">    The class provides three main data preprocessing modes:</span>

<span class="sd">    1. Extraction of raw ENA events satisfying quality criteria and saving them as PyTorch tensors.</span>
<span class="sd">    2. Calculation of good data sums (total number of ENA detections per valid time interval).</span>
<span class="sd">    3. Aggregation of ENA detection features by computing physically meaningful statistical</span>
<span class="sd">       descriptors (means, circular means, and standard deviations).</span>

<span class="sd">    The preprocessing is performed independently for each IBEX-Hi and IBEX-Lo energy channel.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Some methods of this class are marked as deprecated and preserved only as</span>
<span class="sd">    legacy artefacts from earlier versions of the analysis pipeline. They are</span>
<span class="sd">    not used in the current implementation but remain available for reference</span>
<span class="sd">    and reproducibility of previous results.</span>

<span class="sd">    ------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MainConfig.yml&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ChannelAnalyzer object.</span>

<span class="sd">        The class requires a configuration file in YAML format, which specifies</span>
<span class="sd">        paths to input tensor directories, instruction files, and output directories.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config : str, optional</span>
<span class="sd">            Path to the YAML configuration file. Default is ``&quot;MainConfig.yml&quot;``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            If the provided configuration file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_tensor_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;ChannelAnalyzer&quot;</span><span class="p">][</span><span class="s2">&quot;hi_tensor_directory&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lo_tensor_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;ChannelAnalyzer&quot;</span><span class="p">][</span><span class="s2">&quot;lo_tensor_directory&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;ChannelAnalyzer&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No such file as </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">. Exception: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ChannelAnalyzer.init_analyzer_tensors">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer.init_analyzer_tensors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_analyzer_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hi_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">&#39;hi_hex_channel&#39;</span><span class="p">,</span> <span class="n">lo_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">&#39;lo_hex_channel&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;save_good_data_sums&quot;</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize multithreaded preprocessing of all IBEX energy channels.</span>

<span class="sd">        Depending on the selected option, the method performs one of the supported</span>
<span class="sd">        preprocessing procedures independently for each channel using a thread pool.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hi_name : str, optional</span>
<span class="sd">            Filename prefix for IBEX-Hi channel tensor files.</span>
<span class="sd">        lo_name : str, optional</span>
<span class="sd">            Filename prefix for IBEX-Lo channel tensor files.</span>
<span class="sd">        option : str, optional</span>
<span class="sd">            Type of preprocessing to perform. Supported values are:</span>

<span class="sd">            - ``&quot;save_raw_good_data&quot;`` — extract and save raw filtered ENA events.</span>
<span class="sd">            - ``&quot;save_good_data_sums&quot;`` — compute and save ENA detection sums.</span>
<span class="sd">            - ``&quot;aggregate_all_physical_features&quot;`` — aggregate ENA features for global analysis.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If an unsupported option value is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_channel</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">hi_name</span><span class="p">,</span> <span class="n">lo_name</span><span class="p">,</span> <span class="n">option</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during processing channel: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_process_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hi_name</span><span class="p">:</span><span class="nb">str</span> <span class="p">,</span> <span class="n">lo_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a single IBEX energy channel according to the selected preprocessing option.</span>

<span class="sd">        The method loads the corresponding tensor file for the given channel index,</span>
<span class="sd">        selects the appropriate instruction file (IBEX-Hi or IBEX-Lo), and applies</span>
<span class="sd">        one of the supported preprocessing procedures:</span>

<span class="sd">        - extraction of raw ENA events,</span>
<span class="sd">        - computation of good data sums,</span>
<span class="sd">        - aggregation of physical features for global analysis.</span>

<span class="sd">        The results are saved to disk in the output directory specified in the</span>
<span class="sd">        configuration file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int</span>
<span class="sd">            Global channel index (1–14). Channels 1–6 correspond to IBEX-Hi,</span>
<span class="sd">            while channels 7–14 correspond to IBEX-Lo.</span>
<span class="sd">        hi_name : str</span>
<span class="sd">            Filename prefix for IBEX-Hi tensor files.</span>
<span class="sd">        lo_name : str</span>
<span class="sd">            Filename prefix for IBEX-Lo tensor files.</span>
<span class="sd">        option : str</span>
<span class="sd">            Preprocessing option to be applied. See ``init_analyzer_tensors``</span>
<span class="sd">            for the list of supported values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_tensor_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hi_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lo_tensor_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lo_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">6</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">instruction_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;ChannelAnalyzer&quot;</span><span class="p">][</span><span class="s2">&quot;hi_instruction_file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;ChannelAnalyzer&quot;</span><span class="p">][</span><span class="s2">&quot;lo_instruction_file&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tensor_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tensor file not found: </span><span class="si">{</span><span class="n">tensor_path</span><span class="si">}</span><span class="s2">. Skipping channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">tensor_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tensor_path</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading tensor for channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping...&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">is_hi_channel</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">==</span><span class="s2">&quot;save_raw_good_data&quot;</span><span class="p">:</span>
            <span class="n">good_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_good_raw_data</span><span class="p">(</span>
                <span class="n">tensor</span><span class="p">,</span> <span class="n">instruction_file</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_hi_channel</span>
            <span class="p">)</span>

            <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;channel_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_good_raw.pt&quot;</span>
            <span class="p">)</span>

            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">good_data</span><span class="p">),</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved RAW good data tensor for channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: shape=</span><span class="si">{</span><span class="n">good_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">elif</span>  <span class="n">option</span> <span class="o">==</span><span class="s2">&quot;save_good_data_sums&quot;</span><span class="p">:</span>
            <span class="n">good_data_sums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_good_data_sums</span><span class="p">(</span>
                <span class="n">tensor</span><span class="p">,</span> <span class="n">instruction_file</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_hi_channel</span>
            <span class="p">)</span>

            <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;channel_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_good_data.txt&quot;</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;sum time_delta start_time end_time&quot;</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">good_data_sums</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.6f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved good data sums for channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving good data sums for channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;aggregate_all_physical_features&quot;</span><span class="p">:</span>
            <span class="n">good_data_aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_data_for_global_analysis</span><span class="p">(</span>
                <span class="n">tensor</span><span class="p">,</span> <span class="n">instruction_file</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_hi_channel</span><span class="p">)</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;channel_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_good_data_aggregated.pt&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;sum time_delta start_time end_time rate mean_cos_RA mean_sin_RA R_RA mean_cos_phase mean_sin_phase R_phase mean_X_RE, mean_Y_RE, mean_Z_RE, std_X_RE, std_Y_RE, std_Z_RE, mean_R, std_R&quot;</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">good_data_aggregated</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.6f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved good data aggregated for channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving good data aggregated for channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown option: </span><span class="si">{</span><span class="n">option</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_good_raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">instruction_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_hi_channel</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract raw ENA events that satisfy quality criteria defined in the instruction file.</span>

<span class="sd">        The method filters the input tensor based on valid time intervals and</span>
<span class="sd">        phase/channel availability conditions specified in the corresponding</span>
<span class="sd">        instruction file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tensor : np.ndarray</span>
<span class="sd">            Raw ENA data tensor for the selected channel.</span>
<span class="sd">        instruction_file : str</span>
<span class="sd">            Path to the instruction file defining valid acquisition intervals.</span>
<span class="sd">        channel_index : int</span>
<span class="sd">            Index of the analyzed energy channel.</span>
<span class="sd">        is_hi_channel : bool</span>
<span class="sd">            Indicates whether the data correspond to IBEX-Hi (True) or IBEX-Lo (False).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Array containing filtered ENA events. If no valid events are found,</span>
<span class="sd">            an empty array is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">(</span><span class="n">is_hi_channel</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">)</span>

        <span class="n">instruction_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">instruction_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">good_intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_good_data_intervals</span><span class="p">(</span>
            <span class="n">instruction_data</span><span class="p">,</span> <span class="n">channel_index</span>
        <span class="p">)</span>

        <span class="n">good_rows</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">good_intervals</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">good_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">good_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">good_rows</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_good_data_sums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">instruction_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_hi_channel</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute sums of valid ENA detection events for each good time interval.</span>

<span class="sd">        For each time interval satisfying quality criteria, the method calculates</span>
<span class="sd">        the total number of ENA detections and associates it with the corresponding</span>
<span class="sd">        time span.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tensor : np.ndarray</span>
<span class="sd">            Raw ENA data tensor for the selected channel.</span>
<span class="sd">        instruction_file : str</span>
<span class="sd">            Path to the instruction file defining valid acquisition intervals.</span>
<span class="sd">        channel_index : int</span>
<span class="sd">            Index of the analyzed energy channel.</span>
<span class="sd">        is_hi_channel : bool</span>
<span class="sd">            Indicates whether the data correspond to IBEX-Hi (True) or IBEX-Lo (False).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Array of shape (N, 4) containing:</span>
<span class="sd">            [sum, time_delta, start_time, end_time] for each valid interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">(</span><span class="n">is_hi_channel</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instruction_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">instruction_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading instruction file </span><span class="si">{</span><span class="n">instruction_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">good_data_intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_good_data_intervals</span><span class="p">(</span><span class="n">instruction_data</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">)</span>
        <span class="n">good_data_sums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">good_data_intervals</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span>
            <span class="n">time_delta</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sum_valid_data</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">good_data_sums</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sum_valid_data</span><span class="p">,</span> <span class="n">time_delta</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">good_data_sums</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_data_for_global_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">instruction_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_hi_channel</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate ENA detection data into physically meaningful statistical features.</span>

<span class="sd">        For each valid time interval, the method computes aggregated descriptors</span>
<span class="sd">        such as sums, rates, circular means of angular quantities, and standard</span>
<span class="sd">        deviations of spacecraft position parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tensor : np.ndarray</span>
<span class="sd">            Raw ENA data tensor for the selected channel.</span>
<span class="sd">        instruction_file : str</span>
<span class="sd">            Path to the instruction file defining valid acquisition intervals.</span>
<span class="sd">        channel_index : int</span>
<span class="sd">            Index of the analyzed energy channel.</span>
<span class="sd">        is_hi_channel : bool</span>
<span class="sd">            Indicates whether the data correspond to IBEX-Hi (True) or IBEX-Lo (False).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Aggregated feature matrix for global analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">(</span><span class="n">is_hi_channel</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instruction_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">instruction_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading instruction file </span><span class="si">{</span><span class="n">instruction_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">good_data_intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_good_data_intervals</span><span class="p">(</span><span class="n">instruction_data</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">)</span>
        <span class="n">good_data_aggregated</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">good_data_intervals</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span>
            <span class="n">time_delta</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sum_valid_data</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">sum_valid_data</span> <span class="o">/</span> <span class="n">time_delta</span>
                <span class="c1"># direction of incoming ENA particle</span>
                <span class="n">RA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">valid_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># if RA in deg</span>
                <span class="n">mean_cos_RA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">RA</span><span class="p">))</span>
                <span class="n">mean_sin_RA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">RA</span><span class="p">))</span>
                <span class="n">R_RA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_cos_RA</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">mean_sin_RA</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># phase of the channel lens</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span>
                <span class="n">mean_cos_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">phase</span><span class="p">))</span>
                <span class="n">mean_sin_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">phase</span><span class="p">))</span>
                <span class="n">R_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_cos_phase</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">mean_sin_phase</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># IBEX sattelite location relative to Earth (X, Y, Z)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span>
                <span class="n">mean_X_RE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="n">mean_Y_RE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">mean_Z_RE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
                <span class="n">std_X_RE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="n">std_Y_RE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">std_Z_RE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">mean_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
                <span class="n">std_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

                <span class="n">good_data_aggregated</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sum_valid_data</span><span class="p">,</span> <span class="n">time_delta</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span>
                                             <span class="n">end_time</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">mean_cos_RA</span><span class="p">,</span>
                                             <span class="n">mean_sin_RA</span><span class="p">,</span> <span class="n">R_RA</span><span class="p">,</span> <span class="n">mean_cos_phase</span><span class="p">,</span>
                                             <span class="n">mean_sin_phase</span><span class="p">,</span> <span class="n">R_phase</span><span class="p">,</span> <span class="n">mean_X_RE</span><span class="p">,</span>
                                             <span class="n">mean_Y_RE</span><span class="p">,</span> <span class="n">mean_Z_RE</span><span class="p">,</span> <span class="n">std_X_RE</span><span class="p">,</span>
                                             <span class="n">std_Y_RE</span><span class="p">,</span> <span class="n">std_Z_RE</span><span class="p">,</span> <span class="n">mean_R</span><span class="p">,</span> <span class="n">std_R</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">good_data_aggregated</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_good_data_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction_data</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract valid ENA acquisition time intervals from instruction data.</span>

<span class="sd">        A time interval is considered valid if the full phase range (0–59) is covered</span>
<span class="sd">        and the corresponding channel availability flag is set to 1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        instruction_data : np.ndarray</span>
<span class="sd">            Structured array loaded from the instruction file.</span>
<span class="sd">        channel_index : int</span>
<span class="sd">            Index of the analyzed energy channel.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of dict</span>
<span class="sd">            List of dictionaries with keys ``&#39;start_time&#39;`` and ``&#39;end_time&#39;``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase_start_col</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">phase_end_col</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">channel_bool_checker_col</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">channel_index</span>
        <span class="k">if</span> <span class="n">channel_bool_checker_col</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">channel_bool_checker_col</span> <span class="o">=</span> <span class="n">channel_bool_checker_col</span> <span class="o">-</span> <span class="mi">7</span>
        <span class="n">good_data_intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">instruction_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">channel_bool_checker_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">phase_start_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">phase_end_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">59</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">good_data_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">start_time</span><span class="p">,</span> <span class="s1">&#39;end_time&#39;</span><span class="p">:</span> <span class="n">end_time</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">good_data_intervals</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_hi_channel</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        dtype separation for each of the IBEX measuring devices (IBEX-Hi, IBEX-Lo).</span>
<span class="sd">        :param is_hi_channel:</span>
<span class="sd">        :param channel_index: not used - artefact from previous version of this class</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_hi_channel</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;orbit&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;end_time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;phase_start&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;phase_end&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;U2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_2&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;channel_3&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_5&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_6&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;orbit&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;end_time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;phase_start&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;phase_end&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;U2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_2&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;channel_3&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_5&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_6&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;channel_7&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;channel_8&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">)]</span>

<span class="c1">############################################################  depracated functions  #################################################################################################</span>
<div class="viewcode-block" id="ChannelAnalyzer.pearson_correlation">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer.pearson_correlation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pearson_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span><span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 1.1</span>
<span class="sd">           This method is deprecated and preserved only as a legacy implementation</span>
<span class="sd">           from a previous version of the ChannelAnalyzer class. It is no longer</span>
<span class="sd">           used in the current analysis pipeline.</span>

<span class="sd">        Compute the Pearson correlation coefficient between two one-dimensional arrays.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            First input array.</span>
<span class="sd">        y : np.ndarray</span>
<span class="sd">            Second input array.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Pearson correlation coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>

        <span class="n">mean_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">mean_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">))</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean_x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">mean_y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span></div>


<div class="viewcode-block" id="ChannelAnalyzer.mutual_information">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer.mutual_information">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mutual_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span><span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 1.1</span>
<span class="sd">           Deprecated legacy method retained for reference purposes. Mutual</span>
<span class="sd">           information analysis is no longer part of the current processing workflow.</span>

<span class="sd">        Estimate mutual information between two one-dimensional arrays.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            First input array.</span>
<span class="sd">        y : np.ndarray</span>
<span class="sd">            Second input array.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Estimated mutual information value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">min_length</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">histogram_bin_edges</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">histogram_bin_edges</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mutual_info_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChannelAnalyzer.spearman_correlation">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer.spearman_correlation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">spearman_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 1.1</span>
<span class="sd">           Legacy method retained for backward compatibility with older analysis</span>
<span class="sd">           scripts. Not used in the current version of the pipeline.</span>

<span class="sd">        Compute the Spearman rank correlation coefficient.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            First input array.</span>
<span class="sd">        y : np.ndarray</span>
<span class="sd">            Second input array.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Spearman rank correlation coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">min_length</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
        <span class="n">stat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stat</span></div>


<div class="viewcode-block" id="ChannelAnalyzer.weighted_pearson_correlation">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer.weighted_pearson_correlation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">weighted_pearson_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">time_durations_x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">time_durations_y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span><span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 1.1</span>
<span class="sd">           Deprecated weighted correlation method retained as a historical artefact</span>
<span class="sd">           from an earlier analysis approach. It is not used in the current workflow.</span>

<span class="sd">        Compute a weighted Pearson correlation coefficient using time durations as weights.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            First input array.</span>
<span class="sd">        y : np.ndarray</span>
<span class="sd">            Second input array.</span>
<span class="sd">        time_durations_x : np.ndarray</span>
<span class="sd">            Weights associated with the first array.</span>
<span class="sd">        time_durations_y : np.ndarray</span>
<span class="sd">            Weights associated with the second array.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Weighted Pearson correlation coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
        <span class="n">time_durations_x</span> <span class="o">=</span> <span class="n">time_durations_x</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
        <span class="n">time_durations_y</span> <span class="o">=</span> <span class="n">time_durations_y</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>

        <span class="n">weights_x</span> <span class="o">=</span> <span class="n">time_durations_x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">time_durations_x</span><span class="p">)</span>
        <span class="n">weights_y</span> <span class="o">=</span> <span class="n">time_durations_y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">time_durations_y</span><span class="p">)</span>
        <span class="n">weighted_mean_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">weights_x</span><span class="p">)</span>
        <span class="n">weighted_mean_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">weights_y</span><span class="p">)</span>
        <span class="n">diff_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">weighted_mean_x</span>
        <span class="n">diff_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">weighted_mean_y</span>
        <span class="n">weighted_diff_x</span> <span class="o">=</span> <span class="n">diff_x</span> <span class="o">*</span> <span class="n">weights_x</span>
        <span class="n">weighted_diff_y</span> <span class="o">=</span> <span class="n">diff_y</span> <span class="o">*</span> <span class="n">weights_y</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_diff_x</span> <span class="o">*</span> <span class="n">weighted_diff_y</span><span class="p">)</span>
        <span class="n">denominator_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_diff_x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">denominator_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_diff_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">denominator_x</span> <span class="o">*</span> <span class="n">denominator_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">denominator</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="ChannelAnalyzer.load_data">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 1.1</span>
<span class="sd">           Deprecated I/O helper method retained from a previous version of the class.</span>
<span class="sd">           File loading is no longer handled by this component.</span>

<span class="sd">        Load numerical data from a text file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : str</span>
<span class="sd">            Path to the input file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Loaded data array, or an empty array in case of an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="ChannelAnalyzer.analyze">
<a class="viewcode-back" href="../../api.html#IBEX_Module.TensorAnalyzer.ChannelAnalyzer.analyze">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_path_suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 1.1</span>
<span class="sd">           Deprecated end-to-end analysis routine from an earlier version of the</span>
<span class="sd">           ChannelAnalyzer class. This method is retained for archival and reference</span>
<span class="sd">           purposes only and is not used in the current data processing pipeline.</span>

<span class="sd">        Perform correlation analysis between all energy channels and generate</span>
<span class="sd">        correlation matrices and heatmaps.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str</span>
<span class="sd">            Correlation method identifier (``&#39;pearson&#39;``, ``&#39;weighted_pearson&#39;``,</span>
<span class="sd">            ``&#39;spearman&#39;``, or ``&#39;MI&#39;``).</span>
<span class="sd">        file_path_prefix : str</span>
<span class="sd">            Prefix of input file paths.</span>
<span class="sd">        file_path_suffix : str</span>
<span class="sd">            Suffix of input file paths.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time_durations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path_prefix</span><span class="si">}{</span><span class="n">i</span><span class="si">}{</span><span class="n">file_path_suffix</span><span class="si">}</span><span class="s2">.txt&quot;</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">time_durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load data: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pearson&quot;</span><span class="p">:</span>
            <span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                    <span class="n">correlation_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pearson_correlation</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;weighted_pearson&quot;</span><span class="p">:</span>
            <span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                    <span class="n">correlation_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_pearson_correlation</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">time_durations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">time_durations</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;spearman&quot;</span><span class="p">:</span>
            <span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                    <span class="n">correlation_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spearman_correlation</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MI&quot;</span><span class="p">:</span>
            <span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
                    <span class="n">correlation_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutual_information</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is no such method.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/correlation_matrix_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.4f&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
                    <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Plik </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">)],</span> <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Plik </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">)])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Macierz współczynników korelacji </span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/heatmap_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">IBEX Framework</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>